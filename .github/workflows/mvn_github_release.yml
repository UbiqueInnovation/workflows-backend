name: Runs Maven Install and releases to GitHub
on:
  workflow_call:
    inputs:
      ref_name:
        required: true
        type: string
        description: tag or branch name, used for mvn versions:set
      checkout_lfs:
        required: false
        default: false
        type: boolean
        description: Checkout with lfs, default false
      checkout_submodules:
        required: false
        default: false
        type: string
        description: "Whether to checkout submodules: `true` to checkout submodules or `recursive` to recursively checkout submodules."
      parent_pom:
        required: true
        type: string
      java_version:
        default: '25'
        type: string
        required: false
      use_mvn_central:
        default: false
        type: boolean
        required: false
        description: If false, use artifactory_* input secrets
      release_option_prerelease:
        type: boolean
        default: false
      runs_on:
        required: false
        default: '["ubuntu-latest"]'
        type: string
        description: Set to '["self-hosted", "linux", "stable"]' if needed.
      release_option_files:
        type: string
        description: files for the artifact, e.g. 'eth-ws/target/eth-ws.war'

    secrets:
      artifactory_user:
        required: false
      artifactory_password:
        required: false
      artifactory_url:
        required: false
      artifactory_repo:
        required: false
      repo_token:
        required: true

jobs:
  build:
    runs-on: ${{ fromJson(inputs.runs_on) }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ inputs.ref_name }}
          lfs: ${{ inputs.checkout_lfs }}
          submodules: ${{ inputs.checkout_submodules }}

      - name: Set up JDK
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      - name: Create maven central settings.xml
        if: ${{ inputs.use_mvn_central }}
        uses: whelk-io/maven-settings-xml-action@9dc09b23833fa9aa7f27b63db287951856f3433d

      - name: Create custom artifactory settings.xml
        if: ${{ ! inputs.use_mvn_central }}
        uses: whelk-io/maven-settings-xml-action@9dc09b23833fa9aa7f27b63db287951856f3433d
        with:
          servers: '[{"id": "ubique-artifactory", "username": "${{ secrets.artifactory_user}}", "password": "${{ secrets.artifactory_password }}"}]'
          repositories: '[{"id" : "ubique-artifactory", "url" : "${{ secrets.artifactory_url }}${{ secrets.artifactory_repo }}"}]'

      - name: Set VERSION from ref_name
        run: echo "VERSION=${{ inputs.ref_name }}" >> $GITHUB_ENV

      - name: Replace all characters in `\/:"<>|?*` by `-` in VERSION
        run: echo "VERSION=$(echo "$VERSION" | sed 's/[\/:"<>|?*]/-/g')" >> $GITHUB_ENV

      - name: Strip leading `v` from VERSION
        run: echo "VERSION=${VERSION##v}" >> $GITHUB_ENV

      - name: Set versions
        run: mvn -f ${{ inputs.parent_pom }} versions:set -DnewVersion=$VERSION

      - name: Commit versions
        run: mvn -f ${{ inputs.parent_pom }} versions:commit

      - name: Build with Maven
        run: mvn --batch-mode --update-snapshots install -f ${{ inputs.parent_pom }} -DskipTests

      - name: Create new release
        uses: softprops/action-gh-release@e798e6a1ede8d07b74ac4cdac6bdfa4cc1653907
        with:
          name: ${{ env.VERSION }}
          token: ${{ secrets.repo_token }}
          prerelease: ${{ inputs.release_option_prerelease }}
          files: ${{ inputs.release_option_files }}
