name: Runs Yarn Install
on:
    workflow_call:

        inputs:
            ref_name:
                required: false
                default: ''
                type: string
                description: tag or branch name for checkout
            node_version:
                default: '18'
                type: string
                required: false
            cache_dependency_path:
                default: 'yarn.lock'
                type: string
                required: false
                description: path to e.g. yarn.lock from ${app_directory}/
            app_directory:
                required: true
                type: string
                description: directory that contains the package.json
            release_env:
                required: false
                type: string
                description: if set the given env build is also executed
            build_dir:
                required: false
                default: build
                type: string
            yarn_ci_flag:
                required: false
                default: true
                type: boolean
                description: flag for overriding yarn CI flag (DO NOT USE IT FOR NEW PROJECTS!)

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v3
                with:
                    ref: ${{ inputs.ref_name }}
            -   uses: actions/setup-node@v3
                with:
                    node-version: '${{ inputs.node_version }}'
                    check-latest: true
                    cache: 'yarn'
                    cache-dependency-path: '${{ inputs.app_directory }}/${{ inputs.cache_dependency_path }}'
            -   name: Install dependencies
                run: |
                    yarn install --cwd ${{ inputs.app_directory }}
            -   name: Build for Environment
                if: ${{ inputs.release_env }}
                run: |
                    CI=${{ inputs.yarn_ci_flag }} yarn build:${{ inputs.release_env }} --cwd ${{ inputs.app_directory }}
            -   uses: actions/upload-artifact@v3
                if: ${{ inputs.release_env }}
                with:
                    name: ${{ inputs.ref_name }}-${{ inputs.release_env }}
                    path: ${{ inputs.app_directory }}/${{ inputs.build_dir }}/
