name: Run Sonar Cloud Analysis with Maven Verify
on:
  workflow_call:
    inputs:
      parent_pom:
        required: true
        type: string
      ref_name:
        required: true
        type: string
        description: tag or branch name
      checkout_lfs:
        required: false
        default: false
        type: boolean
        description: Checkout with lfs, default false
      checkout_submodules:
        required: false
        default: false
        type: string
        description: "Whether to checkout submodules: `true` to checkout submodules or `recursive` to recursively checkout submodules."
      java_version:
        default: '25'
        type: string
        required: false
      use_mvn_central:
        default: false
        type: boolean
        required: false
        description: If false, use artifactory_* input secrets
      runs_on:
        required: false
        default: '["ubuntu-latest"]'
        type: string
        description: Set to '["self-hosted", "linux", "stable"]' if needed.
      install_apt_packages:
        required: false
        type: string
        default: ''
        description: space-separated list of apt packages to install before build

    secrets:
      artifactory_user:
        required: false
      artifactory_password:
        required: false
      artifactory_url:
        required: false
      artifactory_repo:
        required: false
      sonar_token:
        required: true

env:
  SONAR_TOKEN: ${{ secrets.sonar_token }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  BRANCH_NAME: ${{ inputs.ref_name }}

jobs:
  code_quality:
    runs-on: ${{ fromJson(inputs.runs_on) }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
          ref: ${{ inputs.ref_name }}
          lfs: ${{ inputs.checkout_lfs }}
          submodules: ${{ inputs.checkout_submodules }}

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2-

      - name: install apt packages '${{ inputs.install_apt_packages }}'
        if: ${{ inputs.install_apt_packages }}
        run: |
          sudo apt update && sudo apt install ${{ inputs.install_apt_packages }}

      - name: Create maven central settings.xml
        if: ${{ inputs.use_mvn_central }}
        uses: whelk-io/maven-settings-xml-action@9dc09b23833fa9aa7f27b63db287951856f3433d

      - name: Create custom artifactory settings.xml
        if: ${{ ! inputs.use_mvn_central }}
        uses: whelk-io/maven-settings-xml-action@9dc09b23833fa9aa7f27b63db287951856f3433d
        with:
          servers: '[{"id": "ubique-artifactory", "username": "${{ secrets.artifactory_user}}", "password": "${{ secrets.artifactory_password }}"}]'
          repositories: '[{"id" : "ubique-artifactory", "url" : "${{ secrets.artifactory_url }}${{ secrets.artifactory_repo }}"}]'

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Determine tag on current commit (HEAD)
        id: get_latest_tag
        shell: bash
        run: |
          set -euo pipefail
          # Ensure tags are available
          git fetch --tags --force

          # List tags that point at the current commit (HEAD)
          TAGS_ON_HEAD=$(git tag --points-at HEAD || true)

          CHOSEN_TAG=""
          CHOSEN_VERSION=""

          if [[ -n "${TAGS_ON_HEAD}" ]]; then
            # Build a list of "<version> <original_tag>" for tags that are plain SemVer (allow leading 'v')
            MAP="$(
              while IFS= read -r t; do
                [[ -z "$t" ]] && continue
                v="${t#v}"
                if [[ "$v" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                  echo "$v $t"
                fi
              done <<< "${TAGS_ON_HEAD}"
            )"

            if [[ -n "${MAP}" ]]; then
              # Pick the highest SemVer among the plain versions present on HEAD
              CHOSEN_LINE=$(echo "${MAP}" | sort -V | tail -n1)
              CHOSEN_VERSION="${CHOSEN_LINE%% *}"
              CHOSEN_TAG="${CHOSEN_LINE##* }"
            fi
          fi

          if [[ -n "${CHOSEN_VERSION}" ]]; then
            echo "Found plain SemVer tag on HEAD: ${CHOSEN_TAG} -> Maven version: ${CHOSEN_VERSION}"
            echo "tag=${CHOSEN_TAG}" >> "$GITHUB_OUTPUT"
            echo "version=${CHOSEN_VERSION}" >> "$GITHUB_OUTPUT"
            echo "is_plain=true" >> "$GITHUB_OUTPUT"
          else
            echo "No plain SemVer tag found on HEAD. Skipping version override."
            echo "tag=" >> "$GITHUB_OUTPUT"
            echo "version=" >> "$GITHUB_OUTPUT"
            echo "is_plain=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set Maven project version to latest tag
        if: ${{ steps.get_latest_tag.outputs.is_plain == 'true' }}
        run: mvn --batch-mode -f ${{ inputs.parent_pom }} versions:set -DnewVersion=${{ steps.get_latest_tag.outputs.version }} -DgenerateBackupPoms=false

      - name: Run analysis using Maven
        run: mvn --batch-mode --update-snapshots -f ${{ inputs.parent_pom }} clean verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
