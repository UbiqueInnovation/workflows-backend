name: Build and Push Docker Images on release/
on:
    workflow_call:
        inputs:
            image_name:
                required: true
                type: string
                description: name of the image to build
            tag_name:
                required: true
                type: string
                description: name of the tag to build
            app_name:
                required: true
                type: string
                description: name to tag the image with
            app_directory:
                required: false
                type: string
                description: directory that is the root context, defaults to docker/app_name
            dockerfile_name:
                required: false
                default: "Dockerfile"
                type: string
                description: Name of the Dockerfile, defaults to 'Dockerfile'

        secrets:
            acr_registry:
                required: true
            acr_username:
                required: true
            acr_password:
                required: true

jobs:
    build:
        name: Build Project
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Set default maven root directory if not empty
              if: ${{ inputs.app_directory  }}
              run: echo "APP_DIRECTORY=${{ inputs.app_directory }}" >> $GITHUB_ENV

            - name: Set default maven root directory if empty
              if: ${{ ! inputs.app_directory  }}
              run: echo "APP_DIRECTORY=docker/${{ inputs.app_name }}" >> $GITHUB_ENV

            - uses: azure/docker-login@v1
              with:
                  login-server: ${{ secrets.acr_registry }}
                  username: ${{ secrets.acr_username }}
                  password: ${{ secrets.acr_password }}

            - name: Docker build and push
              uses: docker/build-push-action@v4
              with:
                  tags: ${{ secrets.acr_registry }}/${{ inputs.image_name }}:${{ inputs.tag_name }}
                  file: docker/${{ env.APP_DIRECTORY }}/${{ inputs.dockerfile_name }}
                  push: true
                  context: docker/${{ env.APP_DIRECTORY }}
